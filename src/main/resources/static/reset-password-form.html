<!DOCTYPE html>
<html lang="EN">
<head>
    <title>Password Reset Successful</title>
    <link rel="icon" href="icon.png" type="image/png">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        form, #successMessage {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: center;
        }

        label, input {
            display: block;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        input[type="submit"], button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="submit"]:hover, button:hover {
            background-color: #0056b3;
        }

        .successMessage {
            color: green;
        }

        #passwordError {
            display: flex; /* Използваме flexbox */
            justify-content: center; /* Центрираме хоризонтално */
            align-items: center; /* Центрираме вертикално */
            color: red;
            margin: 10px 0;
            height: 20px; /* Задаваме фиксирана височина */
        }

        #resetButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<h1><span id="resetTitle">Reset Password</span></h1>
<form id="resetForm">
    <input type="hidden" id="token" value="${token}">
    <label for="password">New Password:</label><br>
    <input type="password" id="password" name="password"><br><br>
    <label for="confirmPassword">Confirm New Password:</label><br>
    <input type="password" id="confirmPassword" name="confirmPassword"><br><br>
    <button type="button" id="resetButton" onclick="resetPassword()" disabled>Reset Password</button>
</form>
<div id="passwordError" style="color: red; display: none;">Passwords do not match!</div>
<div id="successMessage" style="display: none;" class="successMessage">
    <p>Password reset successful!</p>
</div>
<script>
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordError = document.getElementById('passwordError');
    const resetButton = document.getElementById('resetButton');

    function validatePasswords() {
        if (passwordInput.value.length < 6 || confirmPasswordInput.value.length < 6) { // Добавяме проверка за дължина
            passwordError.textContent = "Password must be at least 6 characters long.";
            passwordError.style.display = 'block';
            resetButton.disabled = true;
        } else if (passwordInput.value !== confirmPasswordInput.value) {
            passwordError.textContent = "Passwords do not match!";
            passwordError.style.display = 'block';
            resetButton.disabled = true;
        } else {
            passwordError.style.display = 'none';
            resetButton.disabled = false;
        }
    }

    passwordInput.addEventListener('input', validatePasswords);
    confirmPasswordInput.addEventListener('input', validatePasswords);

    function resetPassword() {
        const token = document.getElementById('token').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        const path = window.location.pathname;
        const endpoint = path.includes('/lootgenerator/') ? '/lootgenerator/update-password' : '/update-password';

        fetch(endpoint, {
            method: 'POST',
            referrerPolicy: "unsafe-url",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                token: token,
                newPassword: password
            })
        })
            .then(response => {
                if (response.ok) {
                    document.getElementById('resetForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('resetTitle').style.display = 'none';
                    document.title = "Password Reset Successful";
                    history.replaceState({}, "Password Reset Successful", window.location.pathname);
                } else {
                    response.text().then(errorMessage => {
                        passwordError.textContent = "Password reset failed!";
                        passwordError.style.display = 'block';
                    });
                }
            });
    }
</script>
</body>
</html>